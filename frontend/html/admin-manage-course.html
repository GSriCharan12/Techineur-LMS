<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manage Courses - Techineur LMS</title>
  <link rel="stylesheet" href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="../css/admin-manage-course.css">
  <script src="../js/config.js"></script>
</head>

<body>
  <header>
    <h1>Techineur LMS - Manage Courses</h1>
  </header>

  <div class="manage-container">
    <h2>Course Management</h2>
    <button id="addCourseBtn" class="add-btn">Add Course</button>

    <table>
      <thead>
        <tr>
          <th>Course ID</th>
          <th>Title</th>
          <th>Instructor</th>
          <th>Section</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>C001</td>
          <td>HTML & CSS Basics</td>
          <td>Jane Smith</td>
          <td class="action-buttons">
            <button class="edit-btn">Edit</button>
            <button class="delete-btn">Delete</button>
          </td>
        </tr>
        <tr>
          <td>C002</td>
          <td>JavaScript Essentials</td>
          <td>Mark Johnson</td>
          <td class="action-buttons">
            <button class="edit-btn">Edit</button>
            <button class="delete-btn">Delete</button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Modal Form -->
  <div id="courseModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2 id="modalTitle">Add Course</h2>
      <form id="courseForm">
        <input type="hidden" id="courseIndex" />
        <label for="courseId">Course ID</label>
        <input type="text" id="courseId" required />

        <label for="courseTitle">Title</label>
        <input type="text" id="courseTitle" required />

        <label for="courseInstructor">Instructor</label>
        <input type="text" id="courseInstructor" required />

        <label for="courseSection">Section</label>
        <select id="courseSection" required>
          <option value="A">Section A</option>
          <option value="B">Section B</option>
          <option value="C">Section C</option>
          <option value="D">Section D</option>
        </select>

        <button type="submit" class="add-btn">Save</button>
      </form>
    </div>
  </div>

  <script>
    /* REPLACE INPUT WITH SELECT FOR FACULTY */
    document.getElementById("courseInstructor").outerHTML = '<select id="courseInstructor" required><option value="">Select Faculty</option></select>';

    const modal = document.getElementById("courseModal");
    const form = document.getElementById("courseForm");
    const courseId = document.getElementById("courseId"); // This is Course Code (e.g. CS101)
    const courseTitle = document.getElementById("courseTitle");
    const courseInstructor = document.getElementById("courseInstructor");
    const courseSection = document.getElementById("courseSection");
    const modalTitle = document.getElementById("modalTitle");
    const tableBody = document.querySelector("table tbody");

    const BASE_URL = window.API_BASE_URL || "http://localhost:5000";
    const API_URL = `${BASE_URL}/api/admin/courses`;
    const FACULTY_URL = `${BASE_URL}/api/admin/faculty-list`;
    const token = localStorage.getItem("token");

    let allCourses = [];

    // Load Faculty into Select
    async function loadFaculty() {
      try {
        const res = await fetch(FACULTY_URL, { headers: { Authorization: `Bearer ${token}` } });
        const faculty = await res.json();
        courseInstructor.innerHTML = '<option value="">Select Faculty</option>';
        faculty.forEach(f => {
          const opt = document.createElement("option");
          opt.value = f.id;
          opt.textContent = f.name;
          courseInstructor.appendChild(opt);
        });
      } catch (err) {
        console.error("Error loading faculty:", err);
      }
    }

    // Load Courses
    async function loadCourses() {
      try {
        const res = await fetch(API_URL);
        allCourses = await res.json();

        tableBody.innerHTML = "";
        allCourses.forEach(c => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${c.course_code}</td>
            <td>${c.course_name}</td>
            <td>${c.faculty_name || "Unassigned"}</td>
            <td>${c.section || "A"}</td>
            <td class="action-buttons">
              <button class="edit-btn" onclick="editCourse('${c.id}')">Edit</button>
              <button class="delete-btn" onclick="deleteCourse('${c.id}')">Delete</button>
            </td>
          `;
          tableBody.appendChild(row);
        });
      } catch (err) {
        console.error("Error loading courses:", err);
      }
    }

    // Add Course
    form.onsubmit = async (e) => {
      e.preventDefault();

      const code = courseId.value.trim();
      const title = courseTitle.value.trim();
      const faculty_id = courseInstructor.value;
      const section = courseSection.value;

      const editId = document.getElementById("courseIndex").value;
      const url = editId ? `${API_URL}/${editId}` : API_URL;
      const method = editId ? "PUT" : "POST";

      console.log("Submitting course:", method, url, { code, title, faculty_id, section });

      try {
        const res = await fetch(url, {
          method: method,
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`
          },
          body: JSON.stringify({ code, title, faculty_id, section })
        });

        if (res.ok) {
          alert("Course saved successfully!");
          modal.style.display = "none";
          loadCourses();
        } else {
          const data = await res.json();
          console.log("Error response:", data);
          alert("Operation failed: " + (data.message || "Unknown error"));
        }
      } catch (err) {
        console.error("Error submitting:", err);
        alert("Network error");
      }
    };

    window.editCourse = (id) => {
      const c = allCourses.find(item => item.id == id);
      if (!c) return;

      form.reset();
      modalTitle.textContent = "Edit Course";
      document.getElementById("courseIndex").value = c.id;
      courseId.value = c.course_code;
      courseTitle.value = c.course_name;
      courseInstructor.value = c.faculty_id || "";
      courseSection.value = c.section || "A";
      modal.style.display = "flex";
    };

    // Delete Course
    window.deleteCourse = async (id) => {
      if (!confirm("Delete this course?")) return;

      try {
        const res = await fetch(`${API_URL}/${id}`, {
          method: "DELETE",
          headers: { Authorization: `Bearer ${token}` }
        });

        if (res.ok) loadCourses();
        else alert("Failed to delete");
      } catch (err) {
        alert("Network error");
      }
    };

    // UI Handlers
    document.getElementById("addCourseBtn").onclick = () => {
      form.reset();
      document.getElementById("courseIndex").value = "";
      modalTitle.textContent = "Add Course";
      modal.style.display = "flex";
    };

    document.querySelector(".close").onclick = () => modal.style.display = "none";
    window.onclick = e => { if (e.target == modal) modal.style.display = "none"; };

    // Init
    loadFaculty();
    loadCourses();
  </script>



  <footer>
    <p>&copy; 2025 Techineur Solutions. All rights reserved.</p>
  </footer>

</body>

</html>